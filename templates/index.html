<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Speech to Text</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
  <h1 class="text-center mb-4">üé§ Bangla Speech Transcription App üé§</h1>

  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Pre-Recorded Audio File</h5>
      <input type="file" id="audioFile" accept=".wav" class="form-control mb-2">
      <button onclick="uploadFile()" class="btn btn-primary">Transcribe Uploaded File</button>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Record from Microphone</h5>
      <button id="recordBtn" class="btn btn-success me-2">Start Recording</button>
      <button id="stopBtn" class="btn btn-danger" disabled>Stop & Transcribe</button>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h5 class="card-title">üìù Transcription Output</h5>
      <p id="output" class="form-control bg-white" style="min-height: 100px;"></p>
      <button onclick="clearOutput()" class="btn btn-secondary mt-2">Clear</button>
    </div>
  </div>
</div>

<script src="/static/recorder.js"></script>
<script>
  let recorder, audioStream;

  document.getElementById('recordBtn').onclick = async function () {
    audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const input = audioContext.createMediaStreamSource(audioStream);
    recorder = new Recorder(input, { numChannels: 1 });
    recorder.record();

    document.getElementById('recordBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
  };

  document.getElementById('stopBtn').onclick = function () {
    recorder.stop();

    // Stop microphone access
    audioStream.getTracks().forEach(track => track.stop());

    // Export WAV and send to backend
    recorder.exportWAV(async function (blob) {
      const formData = new FormData();
      formData.append('file', blob, 'recorded_audio.wav');

      const response = await fetch('/transcribe/', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();
      document.getElementById('output').innerText = "Transcription: " + data.transcription;

      document.getElementById('recordBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
    });
  };

  async function uploadFile() {
    const fileInput = document.getElementById('audioFile');
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    const response = await fetch('/transcribe/', {
      method: 'POST',
      body: formData
    });

    const data = await response.json();
    document.getElementById('output').innerText = data.transcription;
  }

  function clearOutput() {
    document.getElementById('output').innerText = "";
  }
</script>
</body>
</html>
